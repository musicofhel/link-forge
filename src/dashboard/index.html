<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Link Forge Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #1a1b1e;
      color: #dbdee1;
      min-height: 100vh;
    }

    /* Fade-in animation */
    @keyframes fadeIn { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: none; } }
    .fade-in { animation: fadeIn 0.3s ease-out both; }

    /* Skeleton loading */
    @keyframes shimmer {
      0% { background-position: -400px 0; }
      100% { background-position: 400px 0; }
    }
    .skeleton {
      background: linear-gradient(90deg, #2b2d31 25%, #383a40 50%, #2b2d31 75%);
      background-size: 800px 100%;
      animation: shimmer 1.5s infinite;
      border-radius: 6px;
    }

    /* Tab bar */
    .tab-bar {
      display: flex;
      align-items: flex-end;
      gap: 2px;
      padding: 12px 32px 0;
      background: #1a1b1e;
      overflow-x: auto;
      scrollbar-width: thin;
      scrollbar-color: #383a40 transparent;
    }
    .tab {
      padding: 10px 18px 10px;
      background: #2b2d31;
      color: #8e9297;
      border: 1px solid transparent;
      border-bottom: none;
      border-radius: 10px 10px 0 0;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      white-space: nowrap;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 8px;
      position: relative;
    }
    .tab:hover { background: #323439; color: #dbdee1; }
    .tab.active {
      background: #2b2d31;
      color: #ffffff;
      border-color: #3f4147;
      font-weight: 600;
      z-index: 1;
    }
    .tab.active::after {
      content: '';
      position: absolute;
      bottom: -1px;
      left: 0;
      right: 0;
      height: 2px;
      background: #5865f2;
    }
    .tab .avatar {
      width: 22px;
      height: 22px;
      border-radius: 50%;
      background: #5865f2;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: 700;
      color: #fff;
      flex-shrink: 0;
    }
    .tab .avatar img { width: 100%; height: 100%; border-radius: 50%; }
    .tab .avatar svg { width: 14px; height: 14px; fill: #fff; }
    .tab .link-count {
      background: #383a40;
      padding: 2px 7px;
      border-radius: 10px;
      font-size: 11px;
      color: #8e9297;
      font-weight: 600;
    }
    .tab.active .link-count { background: #5865f233; color: #7983f5; }

    /* Header */
    .header {
      background: #2b2d31;
      padding: 16px 32px;
      display: flex;
      align-items: center;
      gap: 16px;
      border-bottom: 1px solid #3f4147;
      flex-wrap: wrap;
    }
    .header-brand {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-right: 8px;
    }
    .header-brand svg { width: 28px; height: 28px; flex-shrink: 0; }
    .header h1 { font-size: 18px; color: #ffffff; font-weight: 700; letter-spacing: -0.3px; }
    .stat-pills { display: flex; gap: 8px; flex-wrap: wrap; }
    .header .stat {
      background: #383a40;
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 12px;
      color: #8e9297;
      display: flex;
      align-items: center;
      gap: 5px;
      transition: background 0.15s;
    }
    .header .stat:hover { background: #404349; }
    .header .stat strong { color: #7983f5; font-size: 14px; font-weight: 700; }

    /* Main grid */
    .main {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      padding: 20px 32px 32px;
      max-width: 1600px;
      margin: 0 auto;
    }
    .card {
      background: #2b2d31;
      border-radius: 12px;
      padding: 20px;
      border: 1px solid #33363b;
      transition: border-color 0.2s;
    }
    .card:hover { border-color: #4f545c; }
    .card h2 {
      font-size: 13px;
      color: #8e9297;
      margin-bottom: 14px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 600;
    }
    .card.full { grid-column: 1 / -1; }
    .graph-container {
      grid-column: 1 / -1;
      height: 600px;
      position: relative;
      overflow: hidden;
    }
    #graph-canvas-dash { width: 100%; cursor: grab; border-radius: 0 0 8px 8px; }
    #graph-canvas-dash:active { cursor: grabbing; }
    .graph-legend {
      position: absolute; bottom: 12px; right: 12px; z-index: 5;
      background: #1a1b1ecc; border: 1px solid #3f414766; border-radius: 8px;
      padding: 8px 12px; display: flex; gap: 12px; font-size: 11px;
    }
    .graph-legend-item { display: flex; align-items: center; gap: 5px; color: #8e9297; }
    .graph-legend-item .dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
    .chart-wrap { position: relative; width: 100%; height: 200px; }
    .chart-wrap canvas { width: 100% !important; height: 100% !important; }

    /* Graph view tabs */
    .view-tabs { display: flex; gap: 6px; margin-bottom: 12px; flex-wrap: wrap; }
    .view-btn {
      background: #383a40;
      border: 1px solid transparent;
      color: #8e9297;
      padding: 5px 14px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 500;
      transition: all 0.15s;
    }
    .view-btn:hover { background: #404349; color: #dbdee1; }
    .view-btn.active { background: #5865f2; color: #ffffff; border-color: #5865f2; }

    /* Link table */
    .table-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 14px;
      gap: 12px;
      flex-wrap: wrap;
    }
    .table-controls { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    .table-controls select, .table-controls input {
      background: #383a40;
      border: 1px solid #4f545c;
      color: #dbdee1;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 13px;
      transition: border-color 0.15s;
    }
    .table-controls select:focus, .table-controls input:focus {
      outline: none;
      border-color: #5865f2;
    }
    .search-wrap .search-input {
      background: #383a40;
      border: 1px solid #4f545c;
      color: #dbdee1;
      padding: 6px 12px 6px 32px;
      border-radius: 6px;
      font-size: 13px;
      width: 220px;
      transition: border-color 0.15s, width 0.2s;
    }
    .search-wrap .search-input:focus { outline: none; border-color: #5865f2; width: 280px; }
    .search-wrap {
      position: relative;
      display: inline-flex;
      align-items: center;
    }
    .search-wrap svg {
      position: absolute;
      left: 10px;
      width: 14px;
      height: 14px;
      fill: #8e9297;
      pointer-events: none;
    }
    .table-wrap { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    th {
      text-align: left;
      padding: 10px 12px;
      border-bottom: 2px solid #3f4147;
      color: #8e9297;
      font-weight: 600;
      cursor: pointer;
      user-select: none;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.4px;
      white-space: nowrap;
      transition: color 0.15s;
    }
    th:hover { color: #ffffff; }
    th .sort-arrow { font-size: 10px; margin-left: 3px; opacity: 0.4; }
    th.sorted .sort-arrow { opacity: 1; color: #5865f2; }
    td { padding: 10px 12px; border-bottom: 1px solid #2f3136; }
    tr { transition: background 0.1s; }
    tbody tr:hover { background: #32353b; }
    td a { color: #7983f5; text-decoration: none; transition: color 0.15s; }
    td a:hover { color: #a5adf5; text-decoration: underline; }
    .score-cell {
      display: flex;
      align-items: center;
      gap: 6px;
      font-variant-numeric: tabular-nums;
      font-weight: 500;
    }
    .score-bar {
      display: inline-block; height: 4px; border-radius: 2px;
      vertical-align: middle; min-width: 4px;
    }
    .badge {
      display: inline-block; padding: 3px 8px; border-radius: 4px;
      font-size: 10px; font-weight: 700; text-transform: uppercase;
      letter-spacing: 0.3px;
    }
    .badge-tool { background: #5865f220; color: #7983f5; }
    .badge-tutorial { background: #57f28720; color: #57f287; }
    .badge-pattern { background: #fee75c20; color: #fee75c; }
    .badge-analysis { background: #eb459e20; color: #eb459e; }
    .badge-reference { background: #99aab520; color: #99aab5; }
    .badge-commentary { background: #ed424520; color: #ed4245; }
    .badge-research-paper { background: #9b59b620; color: #b07cc6; }
    .badge-book { background: #e67e2220; color: #e67e22; }
    .badge-whitepaper { background: #1abc9c20; color: #1abc9c; }
    .badge-report { background: #3498db20; color: #3498db; }

    /* Pagination */
    .pagination {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 14px;
      padding-top: 14px;
      border-top: 1px solid #2f3136;
      font-size: 12px;
      color: #8e9297;
    }
    .pagination-btns { display: flex; gap: 4px; }
    .page-btn {
      background: #383a40;
      border: 1px solid transparent;
      color: #8e9297;
      padding: 5px 10px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 500;
      min-width: 32px;
      text-align: center;
      transition: all 0.15s;
    }
    .page-btn:hover:not(:disabled) { background: #404349; color: #dbdee1; }
    .page-btn.active { background: #5865f2; color: #fff; border-color: #5865f2; }
    .page-btn:disabled { opacity: 0.3; cursor: default; }

    /* Overlap analysis section */
    .overlap-section { display: none; }
    .overlap-section.visible { display: contents; }

    .overlap-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 12px;
    }
    .user-profile-card {
      background: #383a40;
      border-radius: 10px;
      padding: 16px;
      border-left: 3px solid #5865f2;
      transition: transform 0.15s, box-shadow 0.15s;
    }
    .user-profile-card:hover { transform: translateY(-2px); box-shadow: 0 4px 16px rgba(0,0,0,0.3); }
    .user-profile-card .profile-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
    }
    .user-profile-card .profile-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: #5865f2;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      color: #fff;
      font-size: 15px;
      flex-shrink: 0;
    }
    .user-profile-card .profile-avatar img { width: 100%; height: 100%; border-radius: 50%; }
    .user-profile-card .profile-name { font-weight: 600; color: #fff; font-size: 15px; }
    .user-profile-card .profile-stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      font-size: 12px;
      color: #8e9297;
    }
    .user-profile-card .profile-stats .val { color: #7983f5; font-weight: 700; font-size: 16px; display: block; }
    .tag-cloud { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 6px; }
    .tag-pill {
      background: #2b2d3180;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 11px;
      color: #8e9297;
      transition: background 0.15s;
    }
    .tag-pill:hover { background: #2b2d31cc; }
    .tag-pill .tag-count { color: #7983f5; margin-left: 3px; font-weight: 600; }

    /* Overlap pairs */
    .overlap-pair {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 8px;
      border-bottom: 1px solid #33363b;
      transition: background 0.1s;
      border-radius: 4px;
    }
    .overlap-pair:hover { background: #33363b; }
    .overlap-pair:last-child { border-bottom: none; }
    .overlap-pair-users {
      display: flex;
      align-items: center;
      gap: 6px;
      min-width: 180px;
      flex-shrink: 0;
    }
    .overlap-pair-avatar {
      width: 22px;
      height: 22px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      font-weight: 700;
      color: #fff;
      flex-shrink: 0;
    }
    .overlap-pair-amp { color: #6d7078; font-size: 12px; }
    .overlap-pair-bar-wrap {
      flex: 1;
      height: 6px;
      background: #383a40;
      border-radius: 3px;
      overflow: hidden;
    }
    .overlap-pair-bar {
      height: 100%;
      border-radius: 3px;
      background: #5865f2;
      transition: width 0.4s ease;
    }
    .overlap-pair-stats {
      display: flex;
      gap: 12px;
      font-size: 12px;
      color: #8e9297;
      min-width: 140px;
      flex-shrink: 0;
      justify-content: flex-end;
    }
    .overlap-pair-stats strong { color: #7983f5; }

    /* Shared categories list */
    .shared-cat-row {
      display: flex;
      align-items: center;
      padding: 8px 4px;
      border-bottom: 1px solid #33363b;
      font-size: 13px;
      transition: background 0.1s;
      border-radius: 4px;
    }
    .shared-cat-row:hover { background: #33363b; }
    .shared-cat-row:last-child { border-bottom: none; }
    .shared-cat-name { flex: 1; color: #dbdee1; }
    .shared-cat-users { display: flex; gap: 4px; }
    .shared-cat-pip {
      width: 22px;
      height: 22px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      font-weight: 700;
      color: #fff;
    }
    .shared-cat-count {
      font-size: 11px;
      color: #8e9297;
      margin-left: 10px;
      min-width: 44px;
      text-align: right;
    }

    /* Tooltip */
    .tooltip {
      position: absolute; background: #1a1b1e; border: 1px solid #4f545c;
      border-radius: 8px; padding: 10px 14px; font-size: 13px;
      pointer-events: none; opacity: 0; transition: opacity 0.15s;
      max-width: 350px; z-index: 10;
      box-shadow: 0 4px 16px rgba(0,0,0,0.5);
    }
    .tooltip .tt-title { color: #ffffff; font-weight: 600; margin-bottom: 4px; }
    .tooltip .tt-domain { color: #8e9297; font-size: 12px; }
    .tooltip .tt-score { color: #7983f5; margin-top: 4px; }

    /* Empty state */
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #8e9297;
      font-size: 13px;
    }

    /* Chat panel */
    .chat-fab {
      position: fixed;
      bottom: 24px;
      right: 24px;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: #5865f2;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 20px rgba(88, 101, 242, 0.4);
      z-index: 100;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .chat-fab:hover { transform: scale(1.08); box-shadow: 0 6px 28px rgba(88, 101, 242, 0.5); }
    .chat-fab svg { width: 24px; height: 24px; fill: #fff; }
    .chat-fab.open { border-radius: 14px; }

    .chat-panel {
      position: fixed;
      bottom: 24px;
      right: 24px;
      width: 440px;
      max-height: 600px;
      background: #2b2d31;
      border: 1px solid #3f4147;
      border-radius: 16px;
      display: none;
      flex-direction: column;
      z-index: 101;
      box-shadow: 0 8px 40px rgba(0,0,0,0.5);
      animation: chatSlideIn 0.25s ease-out;
    }
    .chat-panel.open { display: flex; }
    @keyframes chatSlideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: none; } }

    .chat-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 18px;
      border-bottom: 1px solid #3f4147;
    }
    .chat-header-title {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 600;
      font-size: 14px;
      color: #fff;
    }
    .chat-header-title svg { width: 18px; height: 18px; fill: #5865f2; }
    .chat-close {
      background: none;
      border: none;
      color: #8e9297;
      cursor: pointer;
      padding: 4px;
      border-radius: 6px;
      transition: background 0.15s;
    }
    .chat-close:hover { background: #383a40; color: #fff; }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      min-height: 200px;
      max-height: 400px;
      scrollbar-width: thin;
      scrollbar-color: #383a40 transparent;
    }

    .chat-msg {
      max-width: 90%;
      padding: 10px 14px;
      border-radius: 12px;
      font-size: 13px;
      line-height: 1.5;
      word-break: break-word;
    }
    .chat-msg.user {
      align-self: flex-end;
      background: #5865f2;
      color: #fff;
      border-bottom-right-radius: 4px;
    }
    .chat-msg.assistant {
      align-self: flex-start;
      background: #383a40;
      color: #dbdee1;
      border-bottom-left-radius: 4px;
    }
    .chat-msg.assistant p { margin: 0 0 8px; }
    .chat-msg.assistant p:last-child { margin-bottom: 0; }
    .chat-msg.assistant strong { color: #fff; }
    .chat-msg.assistant a { color: #7983f5; text-decoration: none; }
    .chat-msg.assistant a:hover { text-decoration: underline; }
    .chat-msg.assistant code {
      background: #2b2d31;
      padding: 1px 5px;
      border-radius: 4px;
      font-size: 12px;
    }
    .chat-msg.assistant ul, .chat-msg.assistant ol {
      margin: 4px 0;
      padding-left: 20px;
    }
    .chat-msg.assistant li { margin: 2px 0; }

    .chat-sources {
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid #4f545c40;
    }
    .chat-sources-label {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.4px;
      color: #8e9297;
      margin-bottom: 4px;
      font-weight: 600;
    }
    .chat-source-link {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 3px 0;
      font-size: 12px;
    }
    .chat-source-link a { color: #7983f5; text-decoration: none; }
    .chat-source-link a:hover { text-decoration: underline; }
    .chat-source-score { color: #8e9297; font-size: 11px; font-variant-numeric: tabular-nums; }

    .chat-thinking {
      align-self: flex-start;
      display: flex;
      gap: 4px;
      padding: 12px 16px;
    }
    .chat-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #5865f2;
      animation: chatBounce 1.4s ease-in-out infinite;
    }
    .chat-dot:nth-child(2) { animation-delay: 0.2s; }
    .chat-dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes chatBounce {
      0%, 80%, 100% { transform: scale(0.6); opacity: 0.4; }
      40% { transform: scale(1); opacity: 1; }
    }

    .chat-input-area {
      display: flex;
      gap: 8px;
      padding: 12px 16px;
      border-top: 1px solid #3f4147;
    }
    .chat-input {
      flex: 1;
      background: #383a40;
      border: 1px solid #4f545c;
      color: #dbdee1;
      padding: 10px 14px;
      border-radius: 10px;
      font-size: 13px;
      font-family: inherit;
      resize: none;
      outline: none;
      transition: border-color 0.15s;
      min-height: 40px;
      max-height: 80px;
    }
    .chat-input:focus { border-color: #5865f2; }
    .chat-input::placeholder { color: #6d7078; }
    .chat-send {
      background: #5865f2;
      border: none;
      color: #fff;
      width: 40px;
      height: 40px;
      border-radius: 10px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: background 0.15s;
    }
    .chat-send:hover { background: #4752c4; }
    .chat-send:disabled { background: #383a40; cursor: default; }
    .chat-send svg { width: 18px; height: 18px; fill: #fff; }

    .chat-welcome {
      text-align: center;
      padding: 20px;
      color: #8e9297;
      font-size: 13px;
    }
    .chat-welcome svg { width: 40px; height: 40px; fill: #5865f2; margin-bottom: 8px; }
    .chat-welcome h3 { color: #fff; font-size: 15px; margin: 0 0 6px; }
    .chat-welcome p { margin: 0; }

    /* Domain favicon */
    .domain-cell {
      display: flex;
      align-items: center;
      gap: 6px;
      color: #8e9297;
      font-size: 12px;
    }
    .domain-cell img {
      width: 14px;
      height: 14px;
      border-radius: 2px;
      flex-shrink: 0;
    }

    /* Link cards */
    .link-list { display: flex; flex-direction: column; gap: 2px; }
    .link-item {
      display: flex; gap: 12px; padding: 10px 14px;
      border-left: 3px solid; border-radius: 6px;
      transition: background 0.15s; cursor: pointer;
      text-decoration: none; color: inherit;
    }
    .link-item:hover { background: #33363b; }
    .link-item-score {
      font-size: 14px; font-weight: 700;
      font-variant-numeric: tabular-nums;
      min-width: 36px; text-align: center;
      padding-top: 2px; flex-shrink: 0;
    }
    .link-item-body { flex: 1; min-width: 0; }
    .link-item-row1 { display: flex; align-items: center; gap: 8px; min-width: 0; }
    .link-item-title {
      font-size: 14px; font-weight: 500; color: #dbdee1;
      overflow: hidden; text-overflow: ellipsis;
      white-space: nowrap; flex: 1; min-width: 0;
    }
    .link-item:hover .link-item-title { color: #7983f5; }
    .link-item-date {
      font-size: 11px; color: #6d7078;
      white-space: nowrap; flex-shrink: 0;
    }
    .link-item-row2 {
      display: flex; align-items: center; gap: 6px;
      font-size: 12px; color: #8e9297; margin-top: 3px;
    }
    .link-item-row2 img { width: 14px; height: 14px; border-radius: 2px; }
    .link-item-concepts {
      display: flex; flex-wrap: wrap; gap: 3px; margin-top: 5px;
    }
    .concept-pill {
      font-size: 10px; padding: 1px 7px; border-radius: 10px;
      background: #383a40; color: #8e9297;
    }

    /* Domain leaderboard */
    .domain-row {
      display: flex; align-items: center; gap: 10px; padding: 6px 0;
      border-bottom: 1px solid #33363b;
    }
    .domain-row:last-child { border-bottom: none; }
    .domain-row .domain-rank { width: 22px; font-size: 11px; color: #6d7078; text-align: right; flex-shrink: 0; }
    .domain-row .domain-icon { width: 16px; height: 16px; flex-shrink: 0; border-radius: 2px; }
    .domain-row .domain-name { flex: 1; font-size: 13px; color: #dbdee1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .domain-row .domain-bar-wrap { flex: 0 0 120px; height: 6px; background: #383a40; border-radius: 3px; overflow: hidden; }
    .domain-row .domain-bar { height: 100%; background: #5865f2; border-radius: 3px; transition: width 0.4s ease; }
    .domain-row .domain-count { width: 32px; font-size: 12px; color: #8e9297; text-align: right; flex-shrink: 0; }

    /* Quality badge on link cards */
    .badge-quality { font-size: 10px; padding: 1px 6px; border-radius: 4px; font-weight: 600; }
    .badge-quality-high { background: #57f28733; color: #57f287; }
    .badge-quality-medium { background: #fee75c33; color: #fee75c; }
    .badge-quality-low { background: #ed424533; color: #ed4245; }

    /* Category pills on link cards */
    .cat-pill {
      font-size: 10px; padding: 1px 7px; border-radius: 10px;
      background: #fee75c22; color: #fee75c; border: 1px solid #fee75c33;
    }

    /* Integration type label */
    .integ-label { font-size: 10px; color: #6d7078; font-style: italic; }

    /* Purpose subtitle */
    .link-item-purpose {
      font-size: 11px; color: #6d7078; font-style: italic;
      overflow: hidden; text-overflow: ellipsis; white-space: nowrap; margin-top: 2px;
    }

    /* Tech bubble grid */
    .tech-bubbles { display: flex; flex-wrap: wrap; gap: 8px; align-items: flex-end; }
    .tech-bubble {
      display: inline-flex; align-items: center; justify-content: center;
      border-radius: 50%; cursor: pointer; transition: all 0.2s;
      position: relative; text-align: center; font-weight: 600;
    }
    .tech-bubble:hover { transform: scale(1.15); z-index: 2; }
    .tech-bubble.active { box-shadow: 0 0 0 3px #fff5; }
    .tech-bubble span { font-size: 10px; color: #fff; pointer-events: none; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; padding: 0 4px; max-width: 100%; }
    .tech-detail-header { font-size: 15px; font-weight: 600; color: #dbdee1; margin-bottom: 8px; }
    .tech-detail-row { display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 6px; }
    .tech-tool-pill {
      font-size: 11px; padding: 3px 10px; border-radius: 6px;
      background: #57f28722; color: #57f287; border: 1px solid #57f28733;
      text-decoration: none;
    }
    .tech-tool-pill:hover { background: #57f28744; }

    /* Category tree */
    .cat-tree-parent {
      padding: 8px 0; border-bottom: 1px solid #33363b; cursor: pointer;
    }
    .cat-tree-parent:last-child { border-bottom: none; }
    .cat-tree-parent-header {
      display: flex; align-items: center; gap: 8px;
    }
    .cat-tree-toggle { color: #6d7078; font-size: 14px; width: 16px; transition: transform 0.2s; }
    .cat-tree-toggle.open { transform: rotate(90deg); }
    .cat-tree-name { flex: 1; font-size: 13px; color: #dbdee1; font-weight: 500; }
    .cat-tree-count { font-size: 12px; color: #8e9297; }
    .cat-tree-children { padding-left: 24px; display: none; }
    .cat-tree-children.open { display: block; }
    .cat-tree-child {
      display: flex; align-items: center; gap: 8px; padding: 4px 0;
    }
    .cat-tree-child-name { flex: 1; font-size: 12px; color: #b5bac1; }
    .cat-tree-child-count { font-size: 11px; color: #6d7078; }

    /* Difficulty pills */
    .diff-pill {
      display: inline-flex; align-items: center; gap: 6px; padding: 6px 14px;
      border-radius: 8px; background: #383a40; font-size: 13px;
    }
    .diff-pill .diff-count { font-weight: 700; font-size: 16px; }
    .diff-pill .diff-label { color: #8e9297; font-size: 12px; }
  </style>
</head>
<body>
  <!-- User tabs -->
  <div class="tab-bar" id="tab-bar">
    <div class="tab active" data-user="">
      <span class="avatar">
        <svg viewBox="0 0 16 16"><path d="M8 1a2 2 0 0 1 2 2v2a2 2 0 1 1-4 0V3a2 2 0 0 1 2-2zm4.5 6a1.5 1.5 0 0 1 1.5 1.5v.5a4 4 0 0 1-4 4h-4a4 4 0 0 1-4-4v-.5A1.5 1.5 0 0 1 3.5 7h9z"/></svg>
      </span>
      All
    </div>
  </div>

  <div class="header">
    <div class="header-brand">
      <svg viewBox="0 0 32 32" fill="none">
        <rect width="32" height="32" rx="8" fill="#5865f2"/>
        <path d="M8 16l4-6 4 6-4 6-4-6zm8 0l4-6 4 6-4 6-4-6z" fill="#fff" opacity="0.9"/>
        <path d="M12 10l4 6-4 6" stroke="#fff" stroke-width="1.5" fill="none" opacity="0.5"/>
      </svg>
      <h1 id="header-title">Link Forge</h1>
    </div>
    <div class="stat-pills">
      <div class="stat" id="stat-links"><strong>-</strong> links</div>
      <div class="stat" id="stat-categories"><strong>-</strong> categories</div>
      <div class="stat" id="stat-tools"><strong>-</strong> tools</div>
      <div class="stat" id="stat-avg">avg forge <strong>-</strong></div>
    </div>
  </div>

  <div class="main">
    <div class="card fade-in">
      <h2>Forge Score Distribution</h2>
      <div class="chart-wrap"><canvas id="scoreChart"></canvas></div>
    </div>
    <div class="card fade-in" style="animation-delay:0.05s">
      <h2>Content Types</h2>
      <div class="chart-wrap"><canvas id="typeChart"></canvas></div>
    </div>
    <div class="card fade-in" style="animation-delay:0.08s">
      <h2>Quality Distribution</h2>
      <div class="chart-wrap"><canvas id="qualityChart"></canvas></div>
    </div>
    <div class="card fade-in" style="animation-delay:0.1s">
      <h2>Integration Type</h2>
      <div class="chart-wrap"><canvas id="integrationChart"></canvas></div>
    </div>
    <div class="card fade-in" style="animation-delay:0.12s">
      <h2>Difficulty Spread</h2>
      <div id="difficulty-spread" style="display:flex;flex-wrap:wrap;gap:10px;align-items:center;min-height:50px"></div>
    </div>
    <div class="card fade-in" style="animation-delay:0.14s">
      <h2>Top Domains</h2>
      <div id="domain-leaderboard" style="max-height:320px;overflow-y:auto;scrollbar-width:thin;scrollbar-color:#383a40 transparent"></div>
    </div>
    <div class="card full fade-in" style="animation-delay:0.16s">
      <h2>Activity Timeline</h2>
      <div style="position:relative;width:100%;height:180px"><canvas id="timelineChart"></canvas></div>
    </div>
    <div class="card full fade-in" style="animation-delay:0.18s">
      <h2>Technology Landscape</h2>
      <div id="tech-landscape" style="min-height:200px"></div>
      <div id="tech-detail" style="display:none;margin-top:12px;padding-top:12px;border-top:1px solid #33363b"></div>
    </div>
    <div class="card fade-in" style="animation-delay:0.2s">
      <h2>Category Hierarchy</h2>
      <div id="category-tree" style="max-height:400px;overflow-y:auto;scrollbar-width:thin;scrollbar-color:#383a40 transparent"></div>
    </div>
    <div class="card fade-in" style="animation-delay:0.2s">
      <div style="height:1px"></div>
    </div>
    <!-- Overlap analysis (All tab only) -->
    <div class="overlap-section visible" id="overlap-section">
      <div class="card full fade-in" style="animation-delay:0.1s">
        <h2>User Profiles</h2>
        <div class="overlap-grid" id="user-profiles" style="max-height:480px;overflow-y:auto;scrollbar-width:thin;scrollbar-color:#383a40 transparent"></div>
      </div>
      <div class="card fade-in" style="animation-delay:0.15s">
        <h2>Top Overlapping Pairs</h2>
        <div id="overlap-pairs"></div>
      </div>
      <div class="card fade-in" style="animation-delay:0.15s">
        <h2>Shared Categories</h2>
        <div style="max-height:360px;overflow-y:auto" id="shared-categories"></div>
      </div>
    </div>

    <div class="card full graph-container fade-in" style="animation-delay:0.1s">
      <h2 style="display:flex;align-items:center;gap:8px">Knowledge Graph<a id="graph-fullscreen-link" href="/graph" target="_blank" title="Open full-screen graph explorer" style="color:#8e9297;transition:color 0.15s;display:inline-flex;align-items:center" onmouseover="this.style.color='#5865f2'" onmouseout="this.style.color='#8e9297'"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg></a></h2>
      <div class="view-tabs">
        <button class="view-btn active" data-view="links_to">LINKS_TO</button>
        <button class="view-btn" data-view="categories">Categories</button>
        <button class="view-btn" data-view="shared_by">Shared By</button>
        <button class="view-btn" data-view="all">All Edges</button>
      </div>
      <div class="tooltip" id="tooltip"></div>
      <canvas id="graph-canvas-dash"></canvas>
      <div class="graph-legend">
        <div class="graph-legend-item"><span class="dot" style="background:#5865f2"></span> Links</div>
        <div class="graph-legend-item"><span class="dot" style="background:#fee75c"></span> Categories</div>
        <div class="graph-legend-item"><span class="dot" style="background:#eb459e"></span> Users</div>
      </div>
    </div>
    <div class="card full fade-in" style="animation-delay:0.15s">
      <div class="table-header">
        <h2 style="margin-bottom:0">All Links</h2>
        <div class="table-controls">
          <div class="search-wrap">
            <svg viewBox="0 0 16 16"><path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/></svg>
            <input type="text" class="search-input" id="filter-search" placeholder="Search links...">
          </div>
          <select id="filter-sort">
            <option value="savedAt:desc">Newest</option>
            <option value="forgeScore:desc">Top Score</option>
            <option value="forgeScore:asc">Lowest Score</option>
            <option value="title:asc">Title A-Z</option>
            <option value="domain:asc">Domain</option>
          </select>
          <input type="number" id="filter-score" placeholder="Min score" min="0" max="1" step="0.05" value="0" style="width:100px">
          <select id="filter-type">
            <option value="">All types</option>
            <option value="tool">Tool</option>
            <option value="tutorial">Tutorial</option>
            <option value="pattern">Pattern</option>
            <option value="analysis">Analysis</option>
            <option value="reference">Reference</option>
            <option value="commentary">Commentary</option>
            <option value="research-paper">Research Paper</option>
            <option value="book">Book</option>
            <option value="whitepaper">Whitepaper</option>
            <option value="report">Report</option>
          </select>
        </div>
      </div>
      <div class="link-list" id="link-list"></div>
      <div class="pagination" id="pagination"></div>
    </div>
  </div>

<!-- Chat FAB + Panel -->
<button class="chat-fab" id="chat-fab" title="Ask the Knowledge Graph">
  <svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H5.17L4 17.17V4h16v12z"/><path d="M7 9h2v2H7zm4 0h2v2h-2zm4 0h2v2h-2z"/></svg>
</button>

<div class="chat-panel" id="chat-panel">
  <div class="chat-header">
    <div class="chat-header-title">
      <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>
      Ask the Graph
    </div>
    <button class="chat-close" id="chat-close">&times;</button>
  </div>
  <div class="chat-messages" id="chat-messages">
    <div class="chat-welcome">
      <svg viewBox="0 0 32 32" fill="none"><rect width="32" height="32" rx="8" fill="#5865f2"/><path d="M8 16l4-6 4 6-4 6-4-6zm8 0l4-6 4 6-4 6-4-6z" fill="#fff" opacity="0.9"/></svg>
      <h3>Ask anything about the knowledge graph</h3>
      <p>What tools should we use? What business could we start? Who knows about X?</p>
    </div>
  </div>
  <div class="chat-input-area">
    <textarea class="chat-input" id="chat-input" placeholder="Ask a question..." rows="1"></textarea>
    <button class="chat-send" id="chat-send" title="Send">
      <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
    </button>
  </div>
</div>

<script>
let currentUser = '';
let scoreChart = null;
let typeChart = null;
let qualityChart = null;
let integrationChart = null;
let timelineChart = null;
// Canvas graph state
let graphSim = null;
let graphQt = null;
let graphTf = d3.zoomIdentity;
let graphHover = null;
let graphDragNode = null;
let graphDragging = false;
let graphView = 'links_to';
let graphDrawFn = null;
let graphFindNodeFn = null;
const GR_EDGE_COLORS = { LINKS_TO: '#5865f2', CATEGORIZED_IN: '#fee75c', MENTIONS_TECH: '#3498db', MENTIONS_TOOL: '#57f287', SHARED_BY: '#eb459e', RELATED_TO: '#8e9297', SUBCATEGORY_OF: '#fee75c', USED_WITH: '#8e9297', TAGGED_WITH: '#b07cc6' };
const GR_NODE_COLORS = { category: '#fee75c', technology: '#3498db', tool: '#57f287', user: '#eb459e' };
function grNodeColor(n) { return n.nodeType === 'link' ? scoreColor(n.forgeScore || 0) : (GR_NODE_COLORS[n.nodeType] || '#6d7078'); }
function grNodeRadius(n) {
  const base = { link: 3, category: 5, technology: 4, tool: 4, user: 8 };
  let r = base[n.nodeType] || 3;
  if (n.connectionCount) r += Math.sqrt(n.connectionCount) * 0.6;
  if (n.nodeType === 'link') r += (n.forgeScore || 0) * 3;
  return r;
}
function grEdgeAlpha(type) {
  if (graphView === 'all') return type === 'SHARED_BY' ? 0.15 : 0.3;
  if (graphView === 'links_to') return type === 'LINKS_TO' ? 0.5 : 0.04;
  if (graphView === 'categories') return type === 'CATEGORIZED_IN' ? 0.4 : 0.04;
  if (graphView === 'shared_by') return type === 'SHARED_BY' ? 0.5 : 0.04;
  return 0.3;
}
function grNodeAlpha(n) {
  if (graphView === 'all') return n.nodeType === 'user' ? 0.7 : 1;
  if (graphView === 'links_to') return n.nodeType === 'link' ? 1 : 0.2;
  if (graphView === 'categories') return n.nodeType === 'category' ? 1 : (n.nodeType === 'link' ? 0.8 : 0.2);
  if (graphView === 'shared_by') return n.nodeType === 'user' ? 1 : (n.nodeType === 'link' ? 0.8 : 0.15);
  return 1;
}
let currentPage = 0;
const PAGE_SIZE = 25;

const SCORE_COLORS = {
  artifact: '#5865f2', guide: '#57f287', analysis: '#fee75c',
  pointer: '#eb459e', commentary: '#ed4245', junk: '#6d7078',
};
const TYPE_COLORS = {
  tool: '#5865f2', tutorial: '#57f287', pattern: '#fee75c',
  analysis: '#eb459e', reference: '#8e9297', commentary: '#ed4245',
  'research-paper': '#b07cc6', book: '#e67e22', whitepaper: '#1abc9c', report: '#3498db',
};
const USER_COLORS = ['#5865f2', '#57f287', '#fee75c', '#eb459e', '#ed4245', '#f0b232', '#9b59b6', '#1abc9c'];

function scoreColor(s) {
  if (s >= 0.85) return SCORE_COLORS.artifact;
  if (s >= 0.65) return SCORE_COLORS.guide;
  if (s >= 0.45) return SCORE_COLORS.analysis;
  if (s >= 0.25) return SCORE_COLORS.pointer;
  if (s >= 0.10) return SCORE_COLORS.commentary;
  return SCORE_COLORS.junk;
}

function scoreTier(s) {
  if (s >= 0.85) return 'artifact';
  if (s >= 0.65) return 'guide';
  if (s >= 0.45) return 'analysis';
  if (s >= 0.25) return 'pointer';
  if (s >= 0.10) return 'commentary';
  return 'junk';
}

function qs(params) {
  const p = new URLSearchParams();
  for (const [k, v] of Object.entries(params)) { if (v) p.set(k, v); }
  return p.toString() ? '?' + p.toString() : '';
}

// Authenticated fetch — session cookie is sent automatically
function apiFetch(url, opts) {
  const headers = { ...(opts?.headers || {}) };
  headers['ngrok-skip-browser-warning'] = 'true';
  return fetch(url, { ...opts, headers, credentials: 'same-origin' });
}

function escapeHtml(s) {
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

// --- Tab system ---
function selectTab(discordId, displayName) {
  currentUser = discordId;
  currentPage = 0;
  document.getElementById('header-title').textContent = discordId ? displayName : 'Link Forge';

  // Update tab active states
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  const activeTab = document.querySelector(`.tab[data-user="${discordId}"]`);
  if (activeTab) {
    activeTab.classList.add('active');
    activeTab.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'nearest' });
  }

  loadStats();
  loadExtraCharts();
  loadTechAndCategories();
  loadLinks();
  loadGraph();
  loadOverlap();
}

async function loadUsers() {
  const res = await apiFetch('/api/users');
  const data = await res.json();
  const bar = document.getElementById('tab-bar');

  // Sort by link count descending for tab ordering
  const sorted = [...data.users].sort((a, b) => b.linkCount - a.linkCount);

  sorted.forEach((u) => {
    const origIdx = data.users.indexOf(u);
    const tab = document.createElement('div');
    tab.className = 'tab';
    tab.dataset.user = u.discordId;

    const avatar = document.createElement('span');
    avatar.className = 'avatar';
    if (u.avatarUrl) {
      avatar.innerHTML = `<img src="${escapeHtml(u.avatarUrl)}" alt="">`;
    } else {
      avatar.textContent = u.displayName.charAt(0).toUpperCase();
      avatar.style.background = USER_COLORS[origIdx % USER_COLORS.length];
    }

    const count = document.createElement('span');
    count.className = 'link-count';
    count.textContent = u.linkCount;

    tab.appendChild(avatar);
    tab.appendChild(document.createTextNode(u.displayName));
    tab.appendChild(count);
    bar.appendChild(tab);
  });

  // Tab click handler
  bar.addEventListener('click', (e) => {
    const tab = e.target.closest('.tab');
    if (!tab) return;
    selectTab(tab.dataset.user, tab.textContent.trim().replace(/\d+$/, '').trim());
  });
}

// --- Stats + Charts ---
async function loadStats() {
  const res = await apiFetch('/api/stats' + qs({ user: currentUser }));
  const data = await res.json();

  document.querySelector('#stat-links strong').textContent = data.counts.links;
  document.querySelector('#stat-categories strong').textContent = data.counts.categories;
  document.querySelector('#stat-tools strong').textContent = data.counts.tools;
  document.querySelector('#stat-avg strong').textContent = data.avgScore;

  if (scoreChart) { scoreChart.destroy(); scoreChart = null; }
  if (typeChart) { typeChart.destroy(); typeChart = null; }

  const sd = data.scoreDistribution;
  scoreChart = new Chart(document.getElementById('scoreChart'), {
    type: 'bar',
    data: {
      labels: ['Artifact (0.85+)', 'Guide (0.65-0.84)', 'Analysis (0.45-0.64)',
               'Pointer (0.25-0.44)', 'Commentary (0.10-0.24)', 'Junk (<0.10)'],
      datasets: [{
        data: [sd.artifact, sd.guide, sd.analysis, sd.pointer, sd.commentary, sd.junk],
        backgroundColor: Object.values(SCORE_COLORS),
        borderWidth: 0, borderRadius: 3, barPercentage: 0.7,
      }]
    },
    options: {
      indexAxis: 'y',
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        x: { ticks: { color: '#8e9297', font: { size: 11 } }, grid: { color: '#33363b' } },
        y: { ticks: { color: '#dbdee1', font: { size: 11 } }, grid: { display: false } }
      }
    }
  });

  typeChart = new Chart(document.getElementById('typeChart'), {
    type: 'doughnut',
    data: {
      labels: data.contentTypes.map(t => t.type),
      datasets: [{
        data: data.contentTypes.map(t => t.count),
        backgroundColor: data.contentTypes.map(t => TYPE_COLORS[t.type] || '#8e9297'),
        borderWidth: 2, borderColor: '#2b2d31',
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      cutout: '55%',
      plugins: {
        legend: {
          position: 'right',
          labels: { color: '#dbdee1', font: { size: 11 }, padding: 8, usePointStyle: true, pointStyleWidth: 10 }
        }
      }
    }
  });
}

const QUALITY_COLORS = { high: '#57f287', medium: '#fee75c', low: '#ed4245', unknown: '#8e9297' };
const DIFF_COLORS = { beginner: '#57f287', intermediate: '#3498db', advanced: '#e67e22', expert: '#ed4245', academic: '#b07cc6' };

async function loadExtraCharts() {
  // Fire all 5 requests in parallel
  const [qualRes, intRes, domRes, diffRes, tlRes] = await Promise.all([
    apiFetch('/api/stats/quality').then(r => r.json()),
    apiFetch('/api/stats/integration').then(r => r.json()),
    apiFetch('/api/stats/domains').then(r => r.json()),
    apiFetch('/api/stats/difficulty').then(r => r.json()),
    apiFetch('/api/stats/timeline').then(r => r.json()),
  ]);

  // Quality doughnut
  if (qualityChart) { qualityChart.destroy(); qualityChart = null; }
  qualityChart = new Chart(document.getElementById('qualityChart'), {
    type: 'doughnut',
    data: {
      labels: qualRes.map(q => q.quality),
      datasets: [{
        data: qualRes.map(q => q.count),
        backgroundColor: qualRes.map(q => QUALITY_COLORS[q.quality] || '#8e9297'),
        borderWidth: 2, borderColor: '#2b2d31',
      }]
    },
    options: {
      responsive: true, maintainAspectRatio: false, cutout: '55%',
      plugins: { legend: { position: 'right', labels: { color: '#dbdee1', font: { size: 11 }, padding: 8, usePointStyle: true, pointStyleWidth: 10 } } }
    }
  });

  // Integration type doughnut
  if (integrationChart) { integrationChart.destroy(); integrationChart = null; }
  const intColors = ['#5865f2', '#57f287', '#fee75c', '#eb459e', '#ed4245', '#f0b232', '#9b59b6', '#1abc9c', '#8e9297'];
  integrationChart = new Chart(document.getElementById('integrationChart'), {
    type: 'doughnut',
    data: {
      labels: intRes.map(i => i.integrationType),
      datasets: [{
        data: intRes.map(i => i.count),
        backgroundColor: intRes.map((_, idx) => intColors[idx % intColors.length]),
        borderWidth: 2, borderColor: '#2b2d31',
      }]
    },
    options: {
      responsive: true, maintainAspectRatio: false, cutout: '55%',
      plugins: { legend: { position: 'right', labels: { color: '#dbdee1', font: { size: 11 }, padding: 8, usePointStyle: true, pointStyleWidth: 10 } } }
    }
  });

  // Domain leaderboard
  const domContainer = document.getElementById('domain-leaderboard');
  const maxDom = domRes.length > 0 ? domRes[0].count : 1;
  domContainer.innerHTML = domRes.map((d, i) => `
    <div class="domain-row">
      <span class="domain-rank">${i + 1}</span>
      <img class="domain-icon" src="https://www.google.com/s2/favicons?domain=${encodeURIComponent(d.domain)}&sz=32" alt="" loading="lazy">
      <span class="domain-name">${escapeHtml(d.domain)}</span>
      <div class="domain-bar-wrap"><div class="domain-bar" style="width:${Math.round(d.count / maxDom * 100)}%"></div></div>
      <span class="domain-count">${d.count}</span>
    </div>
  `).join('');

  // Difficulty spread
  const diffContainer = document.getElementById('difficulty-spread');
  if (diffRes.length === 0) {
    diffContainer.innerHTML = '<span style="color:#6d7078;font-size:13px">No difficulty data</span>';
  } else {
    diffContainer.innerHTML = diffRes.map(d => `
      <div class="diff-pill">
        <span class="diff-count" style="color:${DIFF_COLORS[d.difficulty] || '#8e9297'}">${d.count}</span>
        <span class="diff-label">${escapeHtml(d.difficulty)}</span>
      </div>
    `).join('');
  }

  // Timeline sparkline
  if (timelineChart) { timelineChart.destroy(); timelineChart = null; }
  timelineChart = new Chart(document.getElementById('timelineChart'), {
    type: 'line',
    data: {
      labels: tlRes.map(t => t.week),
      datasets: [{
        data: tlRes.map(t => t.count),
        borderColor: '#5865f2',
        backgroundColor: '#5865f233',
        fill: true,
        tension: 0.3,
        pointRadius: 2,
        pointHoverRadius: 5,
        borderWidth: 2,
      }]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: { legend: { display: false }, tooltip: { mode: 'index', intersect: false } },
      scales: {
        x: { ticks: { color: '#6d7078', font: { size: 10 }, maxRotation: 0, maxTicksLimit: 12 }, grid: { color: '#33363b44' } },
        y: { ticks: { color: '#8e9297', font: { size: 11 } }, grid: { color: '#33363b' }, beginAtZero: true }
      }
    }
  });
}

async function loadTechAndCategories() {
  const [techs, tree] = await Promise.all([
    apiFetch('/api/stats/tech-landscape').then(r => r.json()),
    apiFetch('/api/stats/category-tree').then(r => r.json()),
  ]);

  // Tech landscape bubble chart
  const container = document.getElementById('tech-landscape');
  const detailEl = document.getElementById('tech-detail');
  if (techs.length === 0) {
    container.innerHTML = '<span style="color:#6d7078;font-size:13px">No technology data</span>';
  } else {
    const maxCount = techs[0].linkCount;
    container.innerHTML = '<div class="tech-bubbles">' + techs.map((t, i) => {
      const size = Math.max(40, Math.min(90, 40 + (t.linkCount / maxCount) * 50));
      const hue = Math.round((1 - t.avgScore) * 120); // green(high) to red(low)
      const bg = `hsl(${hue}, 65%, 40%)`;
      return `<div class="tech-bubble" data-idx="${i}" style="width:${size}px;height:${size}px;background:${bg}" title="${escapeHtml(t.name)} — ${t.linkCount} links, avg ${t.avgScore}"><span>${escapeHtml(t.name)}</span></div>`;
    }).join('') + '</div>';

    container.addEventListener('click', (e) => {
      const bubble = e.target.closest('.tech-bubble');
      if (!bubble) return;
      const idx = parseInt(bubble.dataset.idx);
      const t = techs[idx];
      container.querySelectorAll('.tech-bubble').forEach(b => b.classList.remove('active'));
      bubble.classList.add('active');

      let html = `<div class="tech-detail-header">${escapeHtml(t.name)} <span style="font-size:12px;color:#8e9297;font-weight:400">${t.linkCount} links · avg score ${t.avgScore}</span></div>`;
      if (t.tools.length > 0) {
        html += `<div style="font-size:11px;color:#6d7078;margin-bottom:4px;text-transform:uppercase;letter-spacing:0.3px">Tools (USED_WITH)</div>`;
        html += '<div class="tech-detail-row">' + t.tools.map(tool =>
          tool.url ? `<a class="tech-tool-pill" href="${escapeHtml(tool.url)}" target="_blank">${escapeHtml(tool.name)}</a>`
                   : `<span class="tech-tool-pill">${escapeHtml(tool.name)}</span>`
        ).join('') + '</div>';
      } else {
        html += '<div style="font-size:12px;color:#6d7078">No tools linked</div>';
      }
      detailEl.innerHTML = html;
      detailEl.style.display = 'block';
    });
  }

  // Category tree
  const treeEl = document.getElementById('category-tree');
  if (tree.length === 0) {
    treeEl.innerHTML = '<span style="color:#6d7078;font-size:13px">No category hierarchy data</span>';
  } else {
    treeEl.innerHTML = tree.map((p, i) => `
      <div class="cat-tree-parent">
        <div class="cat-tree-parent-header" data-tree-idx="${i}">
          <span class="cat-tree-toggle">▶</span>
          <span class="cat-tree-name">${escapeHtml(p.name)}</span>
          <span class="cat-tree-count">${p.linkCount} links · ${p.children.length} sub</span>
        </div>
        <div class="cat-tree-children" id="cat-tree-${i}">
          ${p.children.map(c => `
            <div class="cat-tree-child">
              <span class="cat-tree-child-name">${escapeHtml(c.name)}</span>
              <span class="cat-tree-child-count">${c.linkCount}</span>
            </div>
          `).join('')}
        </div>
      </div>
    `).join('');

    treeEl.addEventListener('click', (e) => {
      const header = e.target.closest('.cat-tree-parent-header');
      if (!header) return;
      const idx = header.dataset.treeIdx;
      const children = document.getElementById('cat-tree-' + idx);
      const toggle = header.querySelector('.cat-tree-toggle');
      children.classList.toggle('open');
      toggle.classList.toggle('open');
    });
  }
}

// --- Links Table ---
let allLinks = [];
let sortKey = 'savedAt';
let sortAsc = false;

async function loadLinks() {
  const res = await apiFetch('/api/links' + qs({ user: currentUser, limit: '500' }));
  const data = await res.json();
  allLinks = data.links;
  currentPage = 0;
  renderTable();
}

function getFilteredLinks() {
  const minScore = parseFloat(document.getElementById('filter-score').value) || 0;
  const typeFilter = document.getElementById('filter-type').value;
  const search = (document.getElementById('filter-search').value || '').toLowerCase().trim();

  let filtered = allLinks.filter(l => l.forgeScore >= minScore);
  if (typeFilter) filtered = filtered.filter(l => l.contentType === typeFilter);
  if (search) filtered = filtered.filter(l =>
    (l.title || '').toLowerCase().includes(search) ||
    (l.domain || '').toLowerCase().includes(search) ||
    (l.url || '').toLowerCase().includes(search) ||
    (l.purpose || '').toLowerCase().includes(search) ||
    (l.authors || []).some(a => a.toLowerCase().includes(search)) ||
    (l.keyConcepts || []).some(c => c.toLowerCase().includes(search)) ||
    (l.categories || []).some(c => c.toLowerCase().includes(search)) ||
    (l.integrationType || '').toLowerCase().includes(search)
  );

  filtered.sort((a, b) => {
    const av = a[sortKey] ?? '';
    const bv = b[sortKey] ?? '';
    const cmp = typeof av === 'number' ? av - bv : String(av).localeCompare(String(bv));
    return sortAsc ? cmp : -cmp;
  });

  return filtered;
}

function relativeDate(d) {
  if (!d) return '';
  const diff = Date.now() - new Date(d).getTime();
  const mins = Math.floor(diff / 60000);
  if (mins < 1) return 'just now';
  if (mins < 60) return mins + 'm ago';
  const hrs = Math.floor(mins / 60);
  if (hrs < 24) return hrs + 'h ago';
  const days = Math.floor(hrs / 24);
  if (days < 7) return days + 'd ago';
  const weeks = Math.floor(days / 7);
  if (weeks < 5) return weeks + 'w ago';
  const months = Math.floor(days / 30);
  if (months < 12) return months + 'mo ago';
  return Math.floor(days / 365) + 'y ago';
}

function renderTable() {
  const filtered = getFilteredLinks();
  const totalPages = Math.max(1, Math.ceil(filtered.length / PAGE_SIZE));
  if (currentPage >= totalPages) currentPage = totalPages - 1;

  const start = currentPage * PAGE_SIZE;
  const page = filtered.slice(start, start + PAGE_SIZE);
  const container = document.getElementById('link-list');

  if (page.length === 0) {
    container.innerHTML = '<div class="empty-state">No links match your filters</div>';
  } else {
    container.innerHTML = page.map(l => {
      const sc = scoreColor(l.forgeScore);
      const isFile = l.url.startsWith('file:///');
      const title = isFile ? (l.url.split('/').pop() || l.title || l.url) : (l.title || l.url).slice(0, 100);
      const concepts = (l.keyConcepts || []).slice(0, 5);
      const categories = (l.categories || []).slice(0, 3);
      const detailHref = '/link/' + encodeURIComponent(l.url);
      const tag = 'a';
      const href = ` href="${detailHref}"`;

      // Quality badge
      const qualBadge = l.quality ? `<span class="badge-quality badge-quality-${l.quality}">${l.quality}</span>` : '';

      // Integration type label
      const integLabel = l.integrationType ? `<span class="integ-label">${escapeHtml(l.integrationType)}</span>` : '';

      const extIcon = isFile ? '' : `<a href="${escapeHtml(l.url)}" target="_blank" onclick="event.stopPropagation()" style="color:#6d7078;display:inline-flex;align-items:center;margin-left:4px" title="Open original link"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg></a>`;
      let row2 = isFile
        ? '<span style="color:#6d7078">local file</span>'
        : `<img src="https://www.google.com/s2/favicons?domain=${encodeURIComponent(l.domain)}&sz=32" alt="" loading="lazy"><span>${escapeHtml(l.domain)}</span>${extIcon}`;
      if (l.authors && l.authors.length) row2 += ` <span style="color:#4f545c">·</span> ${escapeHtml(l.authors.join(', '))}`;
      if (l.difficulty) row2 += ` <span class="badge" style="font-size:10px;padding:1px 5px;background:#2b2d31">${escapeHtml(l.difficulty)}</span>`;
      if (integLabel) row2 += ` <span style="color:#4f545c">·</span> ${integLabel}`;

      const conceptsHtml = concepts.length
        ? `<div class="link-item-concepts">${concepts.map(c => `<span class="concept-pill">${escapeHtml(c)}</span>`).join('')}</div>`
        : '';

      const catsHtml = categories.length
        ? `<div class="link-item-concepts">${categories.map(c => `<span class="cat-pill">${escapeHtml(c)}</span>`).join('')}</div>`
        : '';

      // Purpose subtitle
      const purposeHtml = l.purpose ? `<div class="link-item-purpose">${escapeHtml(l.purpose)}</div>` : '';

      return `<${tag} class="link-item" style="border-left-color:${sc}"${href}>
        <div class="link-item-score" style="color:${sc}">${l.forgeScore.toFixed(2)}</div>
        <div class="link-item-body">
          <div class="link-item-row1">
            <span class="badge badge-${l.contentType}">${l.contentType}</span>
            ${qualBadge}
            <span class="link-item-title" title="${escapeHtml(l.purpose || '')}">${escapeHtml(title)}</span>
            <span class="link-item-date">${relativeDate(l.savedAt)}</span>
          </div>
          ${purposeHtml}
          <div class="link-item-row2">${row2}</div>
          ${conceptsHtml}
          ${catsHtml}
        </div>
      </${tag}>`;
    }).join('');
  }

  // Pagination
  const pag = document.getElementById('pagination');
  if (filtered.length <= PAGE_SIZE) {
    pag.innerHTML = `<span>${filtered.length} link${filtered.length !== 1 ? 's' : ''}</span><span></span>`;
    return;
  }

  let btns = '';
  btns += `<button class="page-btn" onclick="goPage(0)" ${currentPage === 0 ? 'disabled' : ''}>&laquo;</button>`;
  btns += `<button class="page-btn" onclick="goPage(${currentPage - 1})" ${currentPage === 0 ? 'disabled' : ''}>&lsaquo;</button>`;

  const maxVisible = 7;
  let pages = [];
  if (totalPages <= maxVisible) {
    pages = Array.from({ length: totalPages }, (_, i) => i);
  } else {
    pages = [0];
    let s = Math.max(1, currentPage - 2);
    let e = Math.min(totalPages - 2, currentPage + 2);
    if (currentPage <= 3) { s = 1; e = 5; }
    if (currentPage >= totalPages - 4) { s = totalPages - 6; e = totalPages - 2; }
    if (s > 1) pages.push(-1);
    for (let i = s; i <= e; i++) pages.push(i);
    if (e < totalPages - 2) pages.push(-1);
    pages.push(totalPages - 1);
  }

  for (const p of pages) {
    if (p === -1) {
      btns += `<span style="padding:0 4px;color:#8e9297">...</span>`;
    } else {
      btns += `<button class="page-btn ${p === currentPage ? 'active' : ''}" onclick="goPage(${p})">${p + 1}</button>`;
    }
  }

  btns += `<button class="page-btn" onclick="goPage(${currentPage + 1})" ${currentPage >= totalPages - 1 ? 'disabled' : ''}>&rsaquo;</button>`;
  btns += `<button class="page-btn" onclick="goPage(${totalPages - 1})" ${currentPage >= totalPages - 1 ? 'disabled' : ''}>&raquo;</button>`;

  pag.innerHTML = `
    <span>${start + 1}-${Math.min(start + PAGE_SIZE, filtered.length)} of ${filtered.length} links</span>
    <div class="pagination-btns">${btns}</div>
  `;
}

function goPage(p) {
  const filtered = getFilteredLinks();
  const totalPages = Math.max(1, Math.ceil(filtered.length / PAGE_SIZE));
  currentPage = Math.max(0, Math.min(p, totalPages - 1));
  renderTable();
  // Scroll list into view
  document.querySelector('.link-list').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

// Sort dropdown
document.getElementById('filter-sort').addEventListener('change', (e) => {
  const [key, dir] = e.target.value.split(':');
  sortKey = key;
  sortAsc = dir === 'asc';
  currentPage = 0;
  renderTable();
});

// Filter event listeners
let searchTimeout;
document.getElementById('filter-search').addEventListener('input', () => {
  clearTimeout(searchTimeout);
  searchTimeout = setTimeout(() => { currentPage = 0; renderTable(); }, 200);
});
document.getElementById('filter-score').addEventListener('input', () => { currentPage = 0; renderTable(); });
document.getElementById('filter-type').addEventListener('change', () => { currentPage = 0; renderTable(); });

// --- Force Graph (Canvas) ---
async function loadGraph() {
  if (graphSim) { graphSim.stop(); graphSim = null; }
  graphHover = null;
  graphTf = d3.zoomIdentity;
  graphView = 'links_to';
  document.querySelectorAll('.view-btn').forEach(b => b.classList.toggle('active', b.dataset.view === 'links_to'));

  const container = document.querySelector('.graph-container');
  const canvas = document.getElementById('graph-canvas-dash');
  const ctx = canvas.getContext('2d');
  const dpr = window.devicePixelRatio || 1;
  const tooltip = document.getElementById('tooltip');

  const res = await apiFetch('/api/graph' + qs({ user: currentUser }));
  const data = await res.json();
  const nodes = data.nodes;
  const edges = data.edges;

  // Size canvas to fill remaining space in card
  const cr = container.getBoundingClientRect();
  const canvasR = canvas.getBoundingClientRect();
  const w = Math.floor(cr.width - 40);
  const h = Math.floor(cr.bottom - canvasR.top - 20);
  canvas.style.width = w + 'px';
  canvas.style.height = h + 'px';
  canvas.width = w * dpr;
  canvas.height = h * dpr;

  // Draw
  graphDrawFn = function() {
    const cw = canvas.width, ch = canvas.height;
    ctx.save();
    ctx.setTransform(1, 0, 0, 1, 0, 0);
    ctx.clearRect(0, 0, cw, ch);
    ctx.setTransform(dpr * graphTf.k, 0, 0, dpr * graphTf.k, dpr * graphTf.x, dpr * graphTf.y);
    const zk = graphTf.k;

    // Edges
    for (const e of edges) {
      if (!e.source?.x) continue;
      ctx.beginPath();
      ctx.moveTo(e.source.x, e.source.y);
      ctx.lineTo(e.target.x, e.target.y);
      let alpha = grEdgeAlpha(e.type);
      if (graphHover) {
        const sid = e.source.id ?? e.source, tid = e.target.id ?? e.target;
        alpha = (sid === graphHover.id || tid === graphHover.id) ? 0.8 : Math.min(alpha, 0.03);
      }
      ctx.strokeStyle = GR_EDGE_COLORS[e.type] || '#3f4147';
      ctx.globalAlpha = alpha;
      ctx.lineWidth = (graphHover && ((e.source.id ?? e.source) === graphHover.id || (e.target.id ?? e.target) === graphHover.id)) ? 1.5 : 0.5;
      ctx.stroke();
    }
    ctx.globalAlpha = 1;

    // Nodes
    for (const n of nodes) {
      if (n.x == null) continue;
      const r = grNodeRadius(n);
      ctx.globalAlpha = grNodeAlpha(n);
      ctx.beginPath();
      ctx.arc(n.x, n.y, r, 0, Math.PI * 2);
      ctx.fillStyle = grNodeColor(n);
      ctx.fill();
      if (n.nodeType === 'user') {
        ctx.strokeStyle = '#fff';
        ctx.lineWidth = 2;
        ctx.stroke();
      }
    }
    ctx.globalAlpha = 1;

    // Labels at zoom > 1.5
    if (zk > 1.5) {
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      const minCC = zk > 3 ? 0 : zk > 2 ? 2 : 5;
      for (const n of nodes) {
        if (n.x == null) continue;
        if (n.nodeType !== 'user' && (n.connectionCount || 0) < minCC) continue;
        const label = (n.title || n.id || '').slice(0, 25);
        if (!label) continue;
        const r = grNodeRadius(n);
        const fs = Math.max(7, Math.min(11, 9 / zk));
        ctx.font = `${fs}px -apple-system,sans-serif`;
        const fadeA = Math.min(1, (zk - 1.5) / 1);
        ctx.globalAlpha = fadeA * 0.9;
        ctx.fillStyle = '#b5bac1';
        ctx.fillText(label, n.x, n.y + r + 5 + fs / 2);
      }
      ctx.globalAlpha = 1;
    }

    // Hover ring
    if (graphHover?.x != null) {
      const r = grNodeRadius(graphHover);
      ctx.beginPath();
      ctx.arc(graphHover.x, graphHover.y, r + 3, 0, Math.PI * 2);
      ctx.strokeStyle = '#fff';
      ctx.lineWidth = 1.5;
      ctx.globalAlpha = 0.5;
      ctx.stroke();
      ctx.globalAlpha = 1;
    }
    ctx.restore();
  };

  // Hit detection
  graphFindNodeFn = function(cx, cy) {
    if (!graphQt) return null;
    const gx = (cx - graphTf.x) / graphTf.k, gy = (cy - graphTf.y) / graphTf.k;
    let closest = null, bestD = Infinity;
    graphQt.visit((quad, x0, y0, x1, y1) => {
      if (!quad.length) {
        let nd = quad.data;
        while (nd) {
          const r = grNodeRadius(nd) / graphTf.k * 1.5 + 5 / graphTf.k;
          const dx = gx - nd.x, dy = gy - nd.y, d = Math.sqrt(dx * dx + dy * dy);
          if (d < r && d < bestD) { bestD = d; closest = nd; }
          nd = quad.next;
        }
      }
      const mx = (x0 + x1) / 2, my = (y0 + y1) / 2, hs = Math.max(x1 - x0, y1 - y0) / 2;
      return (Math.abs(gx - mx) - hs > 30 / graphTf.k) || (Math.abs(gy - my) - hs > 30 / graphTf.k);
    });
    return closest;
  };

  // Simulation
  const n = nodes.length;
  const charge = n > 500 ? -30 : -80;
  const dist = n > 500 ? 60 : 80;
  graphSim = d3.forceSimulation(nodes)
    .force('link', d3.forceLink(edges).id(d => d.id).distance(dist).strength(0.3))
    .force('charge', d3.forceManyBody().strength(charge).distanceMax(300))
    .force('center', d3.forceCenter(w / 2, h / 2))
    .force('collision', d3.forceCollide(d => grNodeRadius(d) + 1))
    .alphaDecay(0.02)
    .on('tick', () => {
      graphQt = d3.quadtree().x(d => d.x).y(d => d.y).addAll(nodes);
      graphDrawFn();
    });

  // Zoom (replaces previous via d3 namespace)
  const zoom = d3.zoom()
    .scaleExtent([0.1, 8])
    .filter(ev => {
      if (ev.type === 'wheel') return true;
      if (ev.type === 'dblclick') return false;
      if (ev.type === 'mousedown' && ev.button === 0) return !graphFindNodeFn(ev.offsetX, ev.offsetY);
      return !ev.button;
    })
    .on('zoom', ev => { graphTf = ev.transform; graphDrawFn(); });
  d3.select(canvas).call(zoom);

  // View tabs
  document.querySelectorAll('.view-btn').forEach(btn => {
    btn.onclick = () => {
      document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      graphView = btn.dataset.view;
      if (graphDrawFn) graphDrawFn();
    };
  });
}

// --- Overlap Analysis ---
async function loadOverlap() {
  const section = document.getElementById('overlap-section');
  if (currentUser) {
    section.classList.remove('visible');
    return;
  }
  section.classList.add('visible');

  const res = await apiFetch('/api/overlap');
  const data = await res.json();

  renderUserProfiles(data);
  renderOverlapPairs(data);
  renderSharedCategories(data);
}

function renderUserProfiles(data) {
  const container = document.getElementById('user-profiles');

  // Sort users by link count descending, render all as full cards
  const sorted = [...data.users].sort((a, b) => b.linkCount - a.linkCount);

  container.innerHTML = sorted.map((u) => {
    const idx = data.users.indexOf(u);
    const stats = data.userStats[u.discordId] || {};
    const color = USER_COLORS[idx % USER_COLORS.length];
    const typeBadges = (stats.topTypes || []).slice(0, 4).map(t =>
      `<span class="badge badge-${t.type}">${t.type} ${t.count}</span>`
    ).join(' ');
    const tagPills = (stats.topTags || []).slice(0, 6).map(t =>
      `<span class="tag-pill">${escapeHtml(t.tag)}<span class="tag-count">${t.count}</span></span>`
    ).join('');
    const interestPills = (u.interests || []).map(i =>
      `<span style="font-size:10px;padding:2px 8px;border-radius:10px;background:#5865f222;color:#7983f5;border:1px solid #5865f233">${escapeHtml(i)}</span>`
    ).join(' ');

    const avatarHtml = u.avatarUrl
      ? `<img src="${escapeHtml(u.avatarUrl)}" alt="" style="width:36px;height:36px;border-radius:50%;object-fit:cover;border:2px solid ${color}">`
      : `<div class="profile-avatar" style="background:${color}">${escapeHtml(u.displayName.charAt(0).toUpperCase())}</div>`;

    return `
      <div class="user-profile-card" style="border-left-color:${color}">
        <div class="profile-header">
          ${avatarHtml}
          <div>
            <div class="profile-name">${escapeHtml(u.displayName)}</div>
            <div style="font-size:12px;color:#8e9297">${u.linkCount} links</div>
          </div>
        </div>
        <div class="profile-stats">
          <div><span class="val">${stats.totalCategories || 0}</span> categories</div>
          <div><span class="val">${stats.uniqueCategories || 0}</span> unique</div>
          <div><span class="val">${stats.avgScore || 0}</span> avg score</div>
          <div><span class="val">${stats.maxScore || 0}</span> max score</div>
        </div>
        <div style="margin-top:10px;font-size:11px;color:#6d7078;text-transform:uppercase;letter-spacing:0.3px">Types</div>
        <div style="margin-top:4px">${typeBadges}</div>
        ${tagPills ? `<div style="margin-top:10px;font-size:11px;color:#6d7078;text-transform:uppercase;letter-spacing:0.3px">Top Tags</div><div class="tag-cloud">${tagPills}</div>` : ''}
        ${interestPills ? `<div style="margin-top:10px;font-size:11px;color:#6d7078;text-transform:uppercase;letter-spacing:0.3px">Interests</div><div style="margin-top:4px;display:flex;flex-wrap:wrap;gap:4px">${interestPills}</div>` : ''}
      </div>
    `;
  }).join('');
}

function renderOverlapPairs(data) {
  const container = document.getElementById('overlap-pairs');
  const users = data.users;
  const userMap = {};
  users.forEach((u, i) => { userMap[u.discordId] = { ...u, idx: i }; });

  if (users.length < 2 || data.pairwise.length === 0) {
    container.innerHTML = '<div style="color:#8e9297;font-size:13px;padding:10px">Need 2+ users with shared categories</div>';
    return;
  }

  // Sort pairs by shared categories descending, take top 8
  const topPairs = [...data.pairwise]
    .filter(p => p.sharedCategories > 0)
    .sort((a, b) => b.sharedCategories - a.sharedCategories)
    .slice(0, 8);

  if (topPairs.length === 0) {
    container.innerHTML = '<div style="color:#8e9297;font-size:13px;padding:10px">No overlap between users yet</div>';
    return;
  }

  const maxShared = topPairs[0].sharedCategories;

  container.innerHTML = topPairs.map(p => {
    const uA = userMap[p.userA] || { displayName: '?', idx: 0, avatarUrl: '' };
    const uB = userMap[p.userB] || { displayName: '?', idx: 1, avatarUrl: '' };
    const colA = USER_COLORS[uA.idx % USER_COLORS.length];
    const colB = USER_COLORS[uB.idx % USER_COLORS.length];
    const barPct = Math.round((p.sharedCategories / maxShared) * 100);

    const avA = uA.avatarUrl
      ? `<img src="${escapeHtml(uA.avatarUrl)}" alt="" style="width:24px;height:24px;border-radius:50%;object-fit:cover;border:2px solid ${colA}">`
      : `<div class="overlap-pair-avatar" style="background:${colA}">${escapeHtml(uA.displayName.charAt(0).toUpperCase())}</div>`;
    const avB = uB.avatarUrl
      ? `<img src="${escapeHtml(uB.avatarUrl)}" alt="" style="width:24px;height:24px;border-radius:50%;object-fit:cover;border:2px solid ${colB}">`
      : `<div class="overlap-pair-avatar" style="background:${colB}">${escapeHtml(uB.displayName.charAt(0).toUpperCase())}</div>`;

    return `
      <div class="overlap-pair">
        <div class="overlap-pair-users">
          ${avA}
          <span style="font-size:13px;color:#dbdee1">${escapeHtml(uA.displayName)}</span>
          <span class="overlap-pair-amp">&amp;</span>
          ${avB}
          <span style="font-size:13px;color:#dbdee1">${escapeHtml(uB.displayName)}</span>
        </div>
        <div class="overlap-pair-bar-wrap">
          <div class="overlap-pair-bar" style="width:${barPct}%"></div>
        </div>
        <div class="overlap-pair-stats">
          <span><strong>${p.sharedCategories}</strong> shared</span>
          <span>J=<strong>${p.jaccard}</strong></span>
        </div>
      </div>
    `;
  }).join('');
}

function renderSharedCategories(data) {
  const container = document.getElementById('shared-categories');
  const users = data.users;

  const shared = data.categories.filter(c => c.sharedByCount >= 2);

  if (shared.length === 0) {
    container.innerHTML = '<div style="color:#8e9297;font-size:13px;padding:10px">No shared categories yet</div>';
    return;
  }

  container.innerHTML = shared.map(cat => {
    const pips = users.map((u, i) => {
      const count = cat.users[u.discordId];
      if (!count) return '';
      const color = USER_COLORS[i % USER_COLORS.length];
      const pipContent = u.avatarUrl
        ? `<img src="${escapeHtml(u.avatarUrl)}" alt="" style="width:14px;height:14px;border-radius:50%;vertical-align:middle;margin-right:2px">${count}`
        : count;
      return `<div class="shared-cat-pip" style="background:${color}" title="${escapeHtml(u.displayName)}: ${count} links">${pipContent}</div>`;
    }).join('');

    return `
      <div class="shared-cat-row">
        <span class="shared-cat-name">${escapeHtml(cat.name)}</span>
        <div class="shared-cat-users">${pips}</div>
        <span class="shared-cat-count">${cat.totalLinks} total</span>
      </div>
    `;
  }).join('');
}

// --- Chat Panel ---
const chatFab = document.getElementById('chat-fab');
const chatPanel = document.getElementById('chat-panel');
const chatClose = document.getElementById('chat-close');
const chatMessages = document.getElementById('chat-messages');
const chatInput = document.getElementById('chat-input');
const chatSend = document.getElementById('chat-send');
let chatBusy = false;

chatFab.addEventListener('click', () => {
  chatPanel.classList.toggle('open');
  if (chatPanel.classList.contains('open')) {
    chatFab.style.display = 'none';
    chatInput.focus();
  }
});

chatClose.addEventListener('click', () => {
  chatPanel.classList.remove('open');
  chatFab.style.display = 'flex';
});

chatInput.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendChat();
  }
});

chatInput.addEventListener('input', () => {
  chatInput.style.height = 'auto';
  chatInput.style.height = Math.min(chatInput.scrollHeight, 80) + 'px';
});

chatSend.addEventListener('click', sendChat);

function renderMarkdown(text) {
  // Simple markdown: **bold**, `code`, [link](url), lists, paragraphs
  // Security: escape HTML first, then only allow safe markdown constructs
  return text
    .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
    .replace(/`([^`]+)`/g, '<code>$1</code>')
    .replace(/\[([^\]]+)\]\((https?:\/\/[^\)]+)\)/g, (match, linkText, url) => {
      // Validate URL scheme is strictly http/https (already matched by regex)
      // Double-check: no javascript:, data:, or other schemes after decoding
      try {
        const parsed = new URL(url);
        if (parsed.protocol !== 'http:' && parsed.protocol !== 'https:') return escapeHtml(linkText);
      } catch { return escapeHtml(linkText); }
      return `<a href="${escapeHtml(url)}" target="_blank" rel="noopener noreferrer">${linkText}</a>`;
    })
    .replace(/^- (.+)$/gm, '<li>$1</li>')
    .replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>')
    .replace(/\n{2,}/g, '</p><p>')
    .replace(/\n/g, '<br>')
    .replace(/^/, '<p>').replace(/$/, '</p>')
    .replace(/<p><\/p>/g, '');
}

async function sendChat() {
  if (chatBusy) return;
  const question = chatInput.value.trim();
  if (!question) return;

  // Clear welcome if present
  const welcome = chatMessages.querySelector('.chat-welcome');
  if (welcome) welcome.remove();

  // Add user message
  const userMsg = document.createElement('div');
  userMsg.className = 'chat-msg user';
  userMsg.textContent = question;
  chatMessages.appendChild(userMsg);

  chatInput.value = '';
  chatInput.style.height = 'auto';
  chatBusy = true;
  chatSend.disabled = true;

  // Add thinking dots
  const thinking = document.createElement('div');
  thinking.className = 'chat-thinking';
  thinking.innerHTML = '<div class="chat-dot"></div><div class="chat-dot"></div><div class="chat-dot"></div>';
  chatMessages.appendChild(thinking);
  chatMessages.scrollTop = chatMessages.scrollHeight;

  try {
    const res = await apiFetch('/api/ask', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ question }),
    });

    thinking.remove();

    if (!res.ok) {
      const err = await res.json().catch(() => ({ error: 'Request failed' }));
      const errMsg = document.createElement('div');
      errMsg.className = 'chat-msg assistant';
      errMsg.innerHTML = `<p style="color:#ed4245">Error: ${escapeHtml(err.error || 'Something went wrong')}</p>`;
      chatMessages.appendChild(errMsg);
    } else {
      const data = await res.json();

      const assistantMsg = document.createElement('div');
      assistantMsg.className = 'chat-msg assistant';

      let html = renderMarkdown(data.answer);

      // Add sources
      if (data.sources && data.sources.length > 0) {
        html += '<div class="chat-sources"><div class="chat-sources-label">Sources</div>';
        for (const s of data.sources.slice(0, 5)) {
          const isFile = s.url.startsWith('file:///');
          const displayText = isFile ? s.url.split('/').pop() || s.title || s.url : (s.title || s.url).slice(0, 60);
          html += `<div class="chat-source-link">
            <span class="chat-source-score">${s.forgeScore.toFixed(2)}</span>
            ${isFile ? `<span style="color:#dbdee1">${escapeHtml(displayText)}</span>` : `<a href="${escapeHtml(s.url)}" target="_blank">${escapeHtml(displayText)}</a>`}
          </div>`;
        }
        html += '</div>';
      }

      assistantMsg.innerHTML = html;
      chatMessages.appendChild(assistantMsg);
    }
  } catch (err) {
    thinking.remove();
    const errMsg = document.createElement('div');
    errMsg.className = 'chat-msg assistant';
    errMsg.innerHTML = '<p style="color:#ed4245">Network error — is the server running?</p>';
    chatMessages.appendChild(errMsg);
  }

  chatBusy = false;
  chatSend.disabled = false;
  chatMessages.scrollTop = chatMessages.scrollHeight;
  chatInput.focus();
}

// --- Canvas graph mouse handlers (set up once) ---
(function() {
  const canvas = document.getElementById('graph-canvas-dash');
  const tooltip = document.getElementById('tooltip');

  canvas.addEventListener('mousemove', (e) => {
    if (!graphFindNodeFn || !graphDrawFn) return;
    if (graphDragging && graphDragNode) {
      const gx = (e.offsetX - graphTf.x) / graphTf.k;
      const gy = (e.offsetY - graphTf.y) / graphTf.k;
      graphDragNode.fx = gx;
      graphDragNode.fy = gy;
      graphSim?.alpha(0.3).restart();
      return;
    }
    const node = graphFindNodeFn(e.offsetX, e.offsetY);
    if (node !== graphHover) {
      graphHover = node;
      canvas.style.cursor = node ? 'pointer' : 'grab';
      if (node) {
        if (node.nodeType === 'link') {
          tooltip.innerHTML = `<div class="tt-title">${escapeHtml(node.title || node.id)}</div><div class="tt-domain">${escapeHtml(node.domain || '')}</div><div class="tt-score">Forge: ${(node.forgeScore || 0).toFixed(2)} | ${node.contentType || ''}</div>`;
        } else {
          tooltip.innerHTML = `<div class="tt-title">${escapeHtml(node.title)}</div><div class="tt-domain">${node.nodeType}</div>`;
        }
        tooltip.style.opacity = 1;
        tooltip.style.left = (e.offsetX + 15) + 'px';
        tooltip.style.top = (canvas.offsetTop + e.offsetY - 10) + 'px';
      } else {
        tooltip.style.opacity = 0;
      }
      graphDrawFn();
    } else if (node) {
      tooltip.style.left = (e.offsetX + 15) + 'px';
      tooltip.style.top = (canvas.offsetTop + e.offsetY - 10) + 'px';
    }
  });

  canvas.addEventListener('mouseleave', () => {
    graphHover = null;
    tooltip.style.opacity = 0;
    if (graphDrawFn) graphDrawFn();
  });

  canvas.addEventListener('mousedown', (e) => {
    if (!graphFindNodeFn || e.button !== 0) return;
    const node = graphFindNodeFn(e.offsetX, e.offsetY);
    if (node) {
      graphDragging = true;
      graphDragNode = node;
      node.fx = node.x;
      node.fy = node.y;
      graphSim?.alphaTarget(0.3).restart();
      canvas.style.cursor = 'grabbing';
    }
  });

  window.addEventListener('mouseup', () => {
    if (graphDragging && graphDragNode) {
      graphDragging = false;
      graphDragNode.fx = null;
      graphDragNode.fy = null;
      graphDragNode = null;
      graphSim?.alphaTarget(0);
      const c = document.getElementById('graph-canvas-dash');
      if (c) c.style.cursor = graphHover ? 'pointer' : 'grab';
    }
  });

  canvas.addEventListener('dblclick', (e) => {
    e.preventDefault();
    if (!graphFindNodeFn) return;
    const node = graphFindNodeFn(e.offsetX, e.offsetY);
    if (node && node.nodeType === 'link' && !node.id.startsWith('file:///')) {
      window.open(node.id, '_blank');
    }
  });
})();

// Adjust graph fullscreen link for GUID-based auth path
(function() {
  const link = document.getElementById('graph-fullscreen-link');
  const m = location.pathname.match(/^\/d\/([^/]+)/);
  if (m) link.href = `/d/${m[1]}/graph`;
})();

// Boot
loadUsers().then(() => {
  loadStats();
  loadExtraCharts();
  loadTechAndCategories();
  loadLinks();
  loadGraph();
  loadOverlap();
});
</script>
</body>
</html>
